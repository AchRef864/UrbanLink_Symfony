{% extends 'base.html.twig' %}

{% block title %}Statistiques Chauffeurs{% endblock %}

{% block body %}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
    <!-- Bar chart : nombre de courses -->
    <div class="bg-white p-4 rounded shadow w-full">
      <h6 class="font-semibold mb-2">Top 5 Chauffeurs (Nombre de courses)</h6>
      <div class="h-64">
        <canvas id="chart-count" class="w-full h-full"></canvas>
      </div>
    </div>

    <!-- Bar chart : revenu total -->
    <div class="bg-white p-4 rounded shadow w-full">
      <h6 class="font-semibold mb-2">Top 5 Chauffeurs (Revenu total)</h6>
      <div class="h-64">
        <canvas id="chart-revenue" class="w-full h-full"></canvas>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
    <!-- Sous-performants -->
    <div class="bg-white p-4 rounded shadow w-full">
      <h6 class="font-semibold mb-2">Taxis sous-performants (&lt; 3 courses/semaine)</h6>
      <ul class="list-disc pl-5">
        {% for t in underperformers %}
          <li>{{ t.name }} — {{ t.count }} courses la semaine dernière</li>
        {% else %}
          <li>Aucun taxi sous-performant.</li>
        {% endfor %}
      </ul>
    </div>

    <!-- Donut chart : taux d’acceptation -->
    <div class="bg-white p-4 rounded shadow w-full">
      <h6 class="font-semibold mb-2">Taux d’acceptation des courses</h6>
      <div class="h-64">
        <canvas id="chart-donut" class="w-full h-full"></canvas>
      </div>
      <p class="mt-2 text-sm">
        Acceptées : <strong>{{ accepted }}</strong> /
        Refusées : <strong>{{ refused }}</strong>
      </p>
    </div>
  </div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="{{ asset('assets/js/plugins/chartjs.min.js') }}"></script>
  <script>
    const topCountLabels = {{ topCount|map(t => t.name)|json_encode|raw }};
    const topCountData   = {{ topCount|map(t => t.count)|json_encode|raw }};
    const topRevLabels   = {{ topRevenue|map(t => t.name)|json_encode|raw }};
    const topRevData     = {{ topRevenue|map(t => t.revenue)|json_encode|raw }};
    const acceptData     = {{ [accepted, refused]|json_encode|raw }};

    new Chart(document.getElementById('chart-count'), {
      type: 'bar',
      data: {
        labels: topCountLabels,
        datasets: [{
          label: 'Nombre de courses',
          data: topCountData,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor:     'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }
      }
    });

    new Chart(document.getElementById('chart-revenue'), {
      type: 'bar',
      data: {
        labels: topRevLabels,
        datasets: [{
          label: 'Revenu total (TND)',
          data: topRevData,
          backgroundColor: 'rgba(75, 192, 192, 0.6)',
          borderColor:     'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }
      }
    });

    new Chart(document.getElementById('chart-donut'), {
      type: 'doughnut',
      data: {
        labels: ['Acceptées', 'Refusées'],
        datasets: [{
          data: acceptData,
          backgroundColor: ['rgba(40, 167, 69, 0.6)', 'rgba(220, 53, 69, 0.6)'],
          borderColor:     ['rgba(40, 167, 69, 1)',   'rgba(220, 53, 69, 1)'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%'
      }
    });
  </script>
{% endblock %}
