{% extends 'basef.html.twig' %}

{% block title %}Responses for complaints{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rateYo/2.3.2/jquery.rateyo.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rateYo/2.3.2/jquery.rateyo.min.js"></script>
    {{ encore_entry_link_tags('app') }}
    <style>
        .rate-container { display: inline-block; }
    </style>
{% endblock %}

{% block body %}
<div class="card-3d">
    <div class="header-3d">
        <h6>Responses for Complaint #{{ avis_id }}</h6>
        {% if app.user and 'ROLE_ADMIN' in app.user.roles %}
            <a href="{{ path('app_reponse_new', {'avisId': avis_id}) }}" class="btn-add">+ New Response</a>
        {% endif %}
    </div>

    <div class="table-3d overflow-x-auto">
        <table id="reponses-table">
            <thead>
                <tr>
                    <th>Comment</th>
                    <th>Date</th>
                    <th>Admin's Email</th>
                    <th>Rating</th>
                    {% if app.user and 'ROLE_ADMIN' in app.user.roles %}
                        <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for reponse in reponses %}
                    <tr data-id="{{ reponse.id }}">
                        <td>{{ reponse.commentaire }}</td>
                        <td>{{ reponse.dateReponse|date('Y-m-d') }}</td>
                        <td>{{ reponse.user ? reponse.user.username : 'Unknown' }}</td>
                        <td>
                            <div class="rate-yo" id="rating-{{ reponse.id }}" data-rate="{{ reponse.rate ?? 0 }}" data-readonly="{{ reponse.rate ? 'true' : 'false' }}"></div>
                            {% if reponse.rate is null %}
                                <form method="post" action="{{ path('app_reponse_rate', {'id': reponse.id}) }}">
                                    <input type="hidden" name="rate" id="rate-input-{{ reponse.id }}" value="">
                                    <button type="submit" class="btn btn-sm btn-primary mt-2">Submit</button>
                                </form>
                            {% endif %}
                        </td>
                        {% if app.user and 'ROLE_ADMIN' in app.user.roles %}
                            <td>
                                <a href="{{ path('app_reponse_edit', {'id': reponse.id}) }}">Edit</a>
                                <form method="post" action="{{ path('app_reponse_delete', {'id': reponse.id}) }}" onsubmit="return confirm('Are you sure?');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reponse.id) }}">
                                    <button type="submit">Delete</button>
                                </form>
                            </td>
                        {% endif %}
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="5">No responses found.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
    {{ encore_entry_script_tags('app') }}
    <script>
        $(function() {
            $('#reponses-table').DataTable();
            
            // Initialize RateYo for each rating element
            $('.rate-yo').each(function() {
                const $el = $(this);
                const id = $el.attr('id').split('-')[1];
                const rating = parseFloat($el.data('rate'));
                const readonly = $el.data('readonly') === 'true';
                
                $el.rateYo({
                    rating: rating,
                    fullStar: true,
                    readOnly: readonly,
                    onSet: function(rating) {
                        if (!readonly) {
                            $('#rate-input-' + id).val(rating);
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}